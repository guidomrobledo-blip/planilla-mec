<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MEC ‚Äì Reemplazos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
  body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; }
  main { padding: 15px; max-width: 500px; margin: auto; }
  h2 { text-align: center; color: #333; }
  label { font-weight: bold; display: block; margin-top: 15px; }
  
  input, select, button { 
    width: 100%; padding: 12px; font-size: 16px; margin-top: 5px; 
    box-sizing: border-box; border: 1px solid #ccc; border-radius: 8px; 
  }

  button { background-color: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
  .btn-scan { background-color: #6c757d; margin-bottom: 5px; }
  #btnEnviar { background-color: #28a745; margin-top: 25px; font-size: 18px; }

  /* MODAL DEL ESC√ÅNER */
  #scanner-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 1000;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  #reader {
    width: 90%;
    max-width: 400px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
  }

  #btn-cerrar {
    margin-top: 20px;
    width: 60px; height: 60px;
    border-radius: 50%;
    background: white; color: red;
    font-size: 24px; border: 2px solid red;
    display: flex; justify-content: center; align-items: center;
  }

  #mensaje { text-align: center; margin-top: 15px; font-weight: bold; }

  /* --- AVISO VISUAL DE ERROR --- */
  #aviso-error {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border: 3px solid red;
    padding: 20px;
    border-radius: 12px;
    z-index: 2000;
    width: 80%;
    max-width: 350px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
</style>
</head>

<body>

<div id="aviso-error">
  <p style="color: red; font-weight: bold; font-size: 18px;">‚ö†Ô∏è ATENCI√ìN</p>
  <p id="error-texto">Los EAN no pueden ser iguales, por favor corregir</p>
  <button onclick="cerrarAviso()" style="background-color: #6c757d;">Cerrar</button>
</div>

<main>
  <h2>Planilla MEC</h2>

  <label>Pickeador</label>
  <select id="pickeador">
    <option value="">Seleccionar</option>
    <option>Juan</option>
    <option>Ana</option>
    <option>Carlos</option>
  </select>

  <label>Nro Pedido</label>
  <input type="text" id="nro_pedido" inputmode="numeric" pattern="[0-9]*" placeholder="Escanear o manual">
  <button type="button" class="btn-scan" onclick="iniciarEscaneo('nro_pedido')">üì∑ Escanear Pedido</button>

  <label>Fecha</label>
  <input type="date" id="fecha">

  <hr>

  <label>EAN a reemplazar (Manual)</label>
  <input type="text" id="ean_origen" inputmode="numeric" pattern="[0-9]*" placeholder="Ingreso manual">

  <label>Unidades a reemplazar</label>
  <input type="number" id="uni_origen" inputmode="numeric" min="1" value="1">

  <hr>

  <label>EAN de reemplazo</label>
  <input type="text" id="ean_reemplazo" inputmode="numeric" pattern="[0-9]*" placeholder="Escanear o manual">
  <button type="button" class="btn-scan" onclick="iniciarEscaneo('ean_reemplazo')">üì∑ Escanear Reemplazo</button>

  <label>Unidades de reemplazo</label>
  <input type="number" id="uni_reemplazo" inputmode="numeric" min="1" value="1">

  <button id="btnEnviar" onclick="validar()">‚úÖ GUARDAR DATOS</button>
  <p id="mensaje"></p>
</main>

<div id="scanner-modal">
  <div id="reader"></div>
  <button id="btn-cerrar" onclick="detenerEscaneo()">X</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  // --- CONFIGURACI√ìN ---
  const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbxymyQAzHrmo5axoTOJCBQU-B7BNfQf0HaS4mebm8gJLI6M4nna9hEUaEBPL8x-ogoeUg/exec"; 
  // --- FIN CONFIGURACI√ìN ---

  document.getElementById("fecha").valueAsDate = new Date();
  let html5QrCode;
  let campoDestino = ""; 

  function iniciarEscaneo(idCampo) {
    campoDestino = idCampo;
    document.getElementById("scanner-modal").style.display = "flex";
    
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }

    const config = { fps: 10, qrbox: { width: 280, height: 150 }, aspectRatio: 1.0 };

    html5QrCode.start(
        { facingMode: "environment" }, 
        config,
        (decodedText) => {
            document.getElementById(campoDestino).value = decodedText;
            if (navigator.vibrate) navigator.vibrate(100);
            detenerEscaneo();
        },
        (errorMessage) => { }
    ).catch((err) => {
        alert("Error de c√°mara.");
        detenerEscaneo();
    });
  }

  function detenerEscaneo() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
            document.getElementById("scanner-modal").style.display = "none";
        }).catch(() => {
            document.getElementById("scanner-modal").style.display = "none";
        });
    } else {
        document.getElementById("scanner-modal").style.display = "none";
    }
  }

  function mostrarAviso() {
    document.getElementById("aviso-error").style.display = "block";
    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
  }

  function cerrarAviso() {
    document.getElementById("aviso-error").style.display = "none";
  }

  async function validar() {
    const btn = document.getElementById("btnEnviar");
    const datos = {
      pickeador: document.getElementById("pickeador").value,
      nro_pedido: document.getElementById("nro_pedido").value.trim(),
      fecha: document.getElementById("fecha").value,
      ean_origen: document.getElementById("ean_origen").value.trim(),
      uni_origen: document.getElementById("uni_origen").value,
      ean_reemplazo: document.getElementById("ean_reemplazo").value.trim(),
      uni_reemplazo: document.getElementById("uni_reemplazo").value
    };

    if (!datos.pickeador || !datos.nro_pedido || !datos.ean_origen || !datos.ean_reemplazo) {
      mostrar("Faltan datos ‚ùå", "red");
      return;
    }

    // --- NUEVA VALIDACI√ìN: EAN IGUALES ---
    if (datos.ean_origen === datos.ean_reemplazo) {
      mostrarAviso();
      return;
    }

    btn.disabled = true;
    mostrar("Guardando... ‚è≥", "orange");

    try {
      await fetch(URL_APPS_SCRIPT, {
        method: "POST",
        mode: "no-cors", 
        body: JSON.stringify(datos)
      });
      
      mostrar("¬°Guardado! ‚úÖ", "green");
      
      document.getElementById("ean_origen").value = "";
      document.getElementById("ean_reemplazo").value = "";
      document.getElementById("uni_origen").value = "1";
      document.getElementById("uni_reemplazo").value = "1";
      
    } catch (err) {
      mostrar("Error de conexi√≥n ‚ùå", "red");
    } finally {
      btn.disabled = false;
    }
  }

  function mostrar(t, c) {
    const m = document.getElementById("mensaje");
    m.innerText = t; m.style.color = c;
  }
</script>
</body>
</html>
