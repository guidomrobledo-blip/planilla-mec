<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MEC ‚Äì Reemplazos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="logo.png.webp">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#003a70">

<style>
  :root {
    --azul-corp: #003a70;
    --gris-fondo: #f4f7f6;
    --blanco: #ffffff;
    --verde-exito: #28a745;
    --naranja-edit: #fd7e14;
    --rojo-error: #dc3545;
  }

  body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--gris-fondo); color: #333; padding-bottom: 100px; }
  
  header { 
    background: var(--azul-corp); color: white; padding: 15px; text-align: center;
    position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  header span { font-weight: bold; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; }

  main { padding: 15px; max-width: 500px; margin: auto; }

  .card {
    background: var(--blanco); border-radius: 15px; padding: 18px; margin-bottom: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .card-title {
    font-size: 13px; font-weight: bold; color: var(--azul-corp);
    margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 5px; text-transform: uppercase;
  }
  
  label { font-weight: 600; display: block; margin-top: 10px; font-size: 14px; color: #555; }
  input, select { 
    width: 100%; padding: 12px; font-size: 16px; margin-top: 5px; 
    box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; background: #fdfdfd;
  }

  /* BARRA INFERIOR */
  .bottom-nav {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 450px; background: #333; height: 70px; border-radius: 50px;
    display: flex; align-items: center; justify-content: space-around; padding: 0 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 2000; transition: background 0.3s;
  }
  .nav-item {
    display: flex; flex-direction: column; align-items: center; color: white;
    background: none; border: none; cursor: pointer; font-size: 10px;
  }
  .btn-main {
    background: var(--verde-exito); color: white; border: none; padding: 12px 25px;
    border-radius: 50px; font-weight: bold; font-size: 14px; min-width: 160px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  .nav-edit-mode { background: #555; }

  .btn-scan { background-color: #f0f0f0; color: var(--azul-corp); border: 1px solid var(--azul-corp); width: 100%; padding: 10px; border-radius: 50px; font-weight: bold; margin-top: 8px; }

  .detalle-container { display: none; background: #eef2ff; padding: 12px; border-radius: 10px; margin-top: 8px; border-left: 5px solid var(--azul-corp); }
  
  /* SISTEMA DE MODALES UNIFICADO */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 4000; align-items: center; justify-content: center;
  }
  .modal-card {
    background: white; width: 85%; max-width: 350px; border-radius: 20px; overflow: hidden;
    box-shadow: 0 15px 35px rgba(0,0,0,0.4); animation: scaleUp 0.2s ease-out;
  }
  @keyframes scaleUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
  
  .modal-header { background: var(--azul-corp); color: white; padding: 12px; text-align: center; font-weight: bold; position: relative; }
  .modal-body { padding: 20px; text-align: center; font-size: 16px; line-height: 1.4; }
  .modal-footer { display: flex; border-top: 1px solid #eee; }
  .modal-btn { 
    flex: 1; padding: 15px; border: none; background: none; font-size: 14px; 
    font-weight: bold; cursor: pointer; text-transform: uppercase;
  }
  .modal-btn-primary { color: var(--azul-corp); }
  .modal-btn-danger { color: var(--rojo-error); }
  .modal-btn-neutral { color: #888; border-right: 1px solid #eee; }

  .icon-alerta { font-size: 40px; display: block; margin-bottom: 10px; }
  .text-rojo { color: var(--rojo-error); font-weight: bold; }

  #scanner-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; flex-direction: column; justify-content: center; align-items: center; }
  #reader { width: 90%; max-width: 400px; background: white; border-radius: 15px; overflow: hidden; }
</style>
</head>
<body>

<header><span id="header-text">REEMPLAZOS MEC</span></header>

<main>
  <div id="mensaje-flotante" style="text-align:center; height: 20px; font-weight:bold;"></div>
  
  <div class="card">
    <div class="card-title">Informaci√≥n de Pedido</div>
    <label>Pickeador</label>
    <select id="pickeador">
      <option value="">Seleccionar</option>
      <option>Juan</option><option>Ana</option><option>Carlos</option>
    </select>
    <label>Nro Pedido</label>
    <input type="text" id="nro_pedido" inputmode="numeric">
    <button type="button" class="btn-scan" onclick="iniciarEscaneo('nro_pedido')">üì∑ Escanear Pedido</button>
    <label>Fecha</label>
    <input type="date" id="fecha">
  </div>

  <div class="card">
    <div class="card-title">Producto Original</div>
    <label>EAN Origen</label>
    <input type="text" id="ean_origen" inputmode="numeric" oninput="checkEAN(this, 'cont_origen')">
    <div id="cont_origen" class="detalle-container">
      <label style="font-size:12px">Detalle Origen (Pesable):</label>
      <input type="text" id="det_origen">
    </div>
    <label>Unidades</label>
    <input type="text" id="uni_origen" inputmode="decimal" value="1">
  </div>

  <div class="card">
    <div class="card-title">Producto Reemplazo</div>
    <label>EAN Reemplazo</label>
    <input type="text" id="ean_reemplazo" inputmode="numeric" oninput="checkEAN(this, 'cont_reemplazo')">
    <button type="button" class="btn-scan" onclick="iniciarEscaneo('ean_reemplazo')">üì∑ Escanear Reemplazo</button>
    <div id="cont_reemplazo" class="detalle-container">
      <label style="font-size:12px">Detalle Reemplazo (Pesable):</label>
      <input type="text" id="det_reemplazo">
    </div>
    <label>Unidades</label>
    <input type="text" id="uni_reemplazo" inputmode="decimal" value="1">
  </div>
</main>

<nav class="bottom-nav" id="bottomNav">
  <button class="nav-item" id="btnIzquierdo" onclick="clickNuevo()"><span style="font-size:24px">‚ûï</span><span id="txtIz">Nuevo</span></button>
  <button class="btn-main" onclick="validar()"><span id="txtCentro">GUARDAR DATOS</span></button>
  <button class="nav-item" id="btnDerecho" onclick="clickEditar()"><span style="font-size:24px">‚úèÔ∏è</span><span id="txtDe">Editar</span></button>
</nav>

<div id="modal-app" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header" id="modal-titulo">AVISO</div>
    <div class="modal-body">
      <span id="modal-icono" class="icon-alerta" style="display:none">‚ö†Ô∏è</span>
      <div id="modal-contenido"></div>
      <input type="number" id="modal-input" style="display:none; margin-top:15px; text-align:center;" placeholder="Fila #">
    </div>
    <div class="modal-footer" id="modal-footer">
      </div>
  </div>
</div>

<div id="scanner-modal"><div id="reader"></div><button onclick="detenerEscaneo()" style="width:60px;height:60px;border-radius:50%;background:white;color:red;margin-top:20px;">X</button></div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const URL_AS = "https://script.google.com/macros/s/AKfycbxymyQAzHrmo5axoTOJCBQU-B7BNfQf0HaS4mebm8gJLI6M4nna9hEUaEBPL8x-ogoeUg/exec";
  let modoEdicion = false, filaEdicion = null, html5QrCode;
  document.getElementById("fecha").valueAsDate = new Date();

  function vibrar() { if (navigator.vibrate) navigator.vibrate(150); }

  // GESTI√ìN DE MODALES PERSONALIZADOS
  function abrirModal({titulo, cuerpo, icono, input, btnOk, btnNo, callback}) {
    document.getElementById("modal-titulo").innerText = titulo;
    document.getElementById("modal-contenido").innerHTML = cuerpo;
    document.getElementById("modal-icono").style.display = icono ? "block" : "none";
    const inpt = document.getElementById("modal-input");
    inpt.style.display = input ? "block" : "none";
    inpt.value = "";
    
    const footer = document.getElementById("modal-footer");
    footer.innerHTML = "";
    
    if(btnNo) {
      let bNo = document.createElement("button");
      bNo.className = "modal-btn modal-btn-neutral";
      bNo.innerText = btnNo;
      bNo.onclick = () => cerrarModal();
      footer.appendChild(bNo);
    }
    
    let bOk = document.createElement("button");
    bOk.className = "modal-btn modal-btn-primary";
    bOk.innerText = btnOk || "ACEPTAR";
    bOk.onclick = () => { 
      let val = inpt.value; 
      cerrarModal(); 
      if(callback) callback(val); 
    };
    footer.appendChild(bOk);
    
    document.getElementById("modal-app").style.display = "flex";
  }

  function cerrarModal() { document.getElementById("modal-app").style.display = "none"; }

  // LOGICA DE BOTONES
  function clickNuevo() {
    if(modoEdicion) cancelarEdicion();
    else {
      abrirModal({
        titulo: "CONFIRMAR",
        cuerpo: "¬øLimpiar todos los campos?",
        btnNo: "NO", btnOk: "S√ç",
        callback: () => {
          document.querySelectorAll("input").forEach(i => i.value="");
          document.getElementById("fecha").valueAsDate = new Date();
          document.getElementById("uni_origen").value = "1";
          document.getElementById("uni_reemplazo").value = "1";
        }
      });
    }
  }

  function clickEditar() {
    if(modoEdicion) {
      abrirModal({
        titulo: "ELIMINAR",
        cuerpo: `¬øSeguro que quieres <b>ELIMINAR</b> la fila ${filaEdicion}?`,
        icono: true, btnNo: "CANCELAR", btnOk: "S√ç, ELIMINAR",
        callback: ejecutarEliminar
      });
    } else {
      abrirModal({
        titulo: "EDITAR FILA",
        cuerpo: "Ingrese el n√∫mero de fila a editar",
        input: true, btnNo: "CANCELAR", btnOk: "BUSCAR",
        callback: (n) => { if(n) cargarFila(n); }
      });
    }
  }

  async function cargarFila(n) {
    mostrar("Buscando...", "orange");
    try {
      const r = await fetch(URL_AS + "?nro_fila=" + n);
      const d = await r.json();
      if(d.status === "error") { mostrar("No encontrada", "red"); return; }
      
      // Mapeo de datos
      document.getElementById("pickeador").value = d.pickeador;
      document.getElementById("nro_pedido").value = d.nro_pedido;
      document.getElementById("fecha").value = d.fecha;
      document.getElementById("ean_origen").value = d.ean_origen;
      document.getElementById("uni_origen").value = d.uni_origen.toString().replace(" kg","");
      document.getElementById("ean_reemplazo").value = d.ean_reemplazo;
      document.getElementById("uni_reemplazo").value = d.uni_reemplazo.toString().replace(" kg","");
      document.getElementById("det_origen").value = d.det_origen || "";
      document.getElementById("det_reemplazo").value = d.det_reemplazo || "";
      
      checkEAN(document.getElementById("ean_origen"), 'cont_origen');
      checkEAN(document.getElementById("ean_reemplazo"), 'cont_reemplazo');
      
      modoEdicion = true; filaEdicion = n;
      actualizarBarra();
      mostrar("Fila cargada", "blue");
    } catch(e) { mostrar("Error", "red"); }
  }

  function actualizarBarra() {
    const nav = document.getElementById("bottomNav");
    if(modoEdicion) {
      nav.classList.add("nav-edit-mode");
      document.getElementById("header-text").innerText = "CORRIGIENDO FILA " + filaEdicion;
      document.getElementById("txtIz").innerText = "Cancelar";
      document.getElementById("btnIzquierdo").querySelector("span").innerText = "‚ùå";
      document.getElementById("txtCentro").innerText = "ACTUALIZAR FILA " + filaEdicion;
      document.querySelector(".btn-main").style.background = "var(--naranja-edit)";
      document.getElementById("txtDe").innerText = "Eliminar";
      document.getElementById("btnDerecho").querySelector("span").innerText = "üóëÔ∏è";
    } else {
      nav.classList.remove("nav-edit-mode");
      document.getElementById("header-text").innerText = "REEMPLAZOS MEC";
      document.getElementById("txtIz").innerText = "Nuevo";
      document.getElementById("btnIzquierdo").querySelector("span").innerText = "‚ûï";
      document.getElementById("txtCentro").innerText = "GUARDAR DATOS";
      document.querySelector(".btn-main").style.background = "var(--verde-exito)";
      document.getElementById("txtDe").innerText = "Editar";
      document.getElementById("btnDerecho").querySelector("span").innerText = "‚úèÔ∏è";
    }
  }

  function cancelarEdicion() { modoEdicion = false; filaEdicion = null; actualizarBarra(); }

  async function ejecutarEliminar() {
    mostrar("Eliminando...", "red");
    try {
      await fetch(URL_AS, { method: "POST", body: JSON.stringify({accion: "eliminar", nro_fila: filaEdicion})});
      vibrar(); mostrar("Eliminado ‚úÖ", "green"); cancelarEdicion();
    } catch(e) { mostrar("Error", "red"); }
  }

  async function validar() {
    const d = {
      accion: modoEdicion ? "actualizar" : "insertar",
      nro_fila: filaEdicion,
      pickeador: document.getElementById("pickeador").value,
      nro_pedido: document.getElementById("nro_pedido").value.trim(),
      fecha: document.getElementById("fecha").value,
      ean_origen: document.getElementById("ean_origen").value.trim(),
      uni_origen: formatearUnidad(document.getElementById("uni_origen").value),
      ean_reemplazo: document.getElementById("ean_reemplazo").value.trim(),
      uni_reemplazo: formatearUnidad(document.getElementById("uni_reemplazo").value),
      det_origen: document.getElementById("det_origen").value.trim(),
      det_reemplazo: document.getElementById("det_reemplazo").value.trim()
    };

    if(!d.pickeador || !d.nro_pedido || !d.ean_origen || !d.ean_reemplazo) { mostrar("Faltan datos ‚ùå", "red"); return; }
    
    if(d.ean_origen === d.ean_reemplazo) {
      abrirModal({
        titulo: "ALERTA", icono: true,
        cuerpo: '<span class="text-rojo">EAN_ORIGEN y EAN_REEMPLAZO son iguales.</span>'
      });
      return;
    }

    mostrar("Enviando...", "orange");
    try {
      const r = await fetch(URL_AS, { method: "POST", body: JSON.stringify(d)});
      const res = await r.json();
      if(res.status === "duplicado") {
        abrirModal({
          titulo: "DUPLICADO", icono: true,
          cuerpo: `<span class="text-rojo">${res.mensaje}</span>`
        });
      } else {
        vibrar(); mostrar("¬°√âxito! ‚úÖ", "green");
        if(modoEdicion) cancelarEdicion();
        else {
          document.getElementById("ean_origen").value = ""; document.getElementById("ean_reemplazo").value = "";
          document.querySelectorAll(".detalle-container").forEach(c => c.style.display="none");
        }
      }
    } catch(e) { mostrar("Error", "red"); }
  }

  function checkEAN(i, cId) {
    const pref = ["23", "25", "26", "29"];
    document.getElementById(cId).style.display = pref.some(p => i.value.startsWith(p)) ? "block" : "none";
  }
  function formatearUnidad(v) {
    let s = v.toString().replace(',','.').trim();
    return s.includes('.') ? parseFloat(s) + " kg" : s;
  }
  function mostrar(t, c) { 
    const m = document.getElementById("mensaje-flotante");
    m.innerText = t; m.style.color = c;
    if(c === 'green') setTimeout(() => m.innerText="", 3000);
  }

  function iniciarEscaneo(id) {
    campoDestino = id; document.getElementById("scanner-modal").style.display = "flex";
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } },
      (text) => { 
        vibrar(); document.getElementById(campoDestino).value = text.trim(); 
        if (campoDestino === 'ean_reemplazo') checkEAN(document.getElementById(campoDestino), 'cont_reemplazo');
        detenerEscaneo(); 
      }, () => {}
    ).catch(() => { alert("Error c√°mara"); detenerEscaneo(); });
  }
  function detenerEscaneo() {
    if (html5QrCode && html5QrCode.isScanning) {
      html5QrCode.stop().then(() => { document.getElementById("scanner-modal").style.display = "none"; });
    } else { document.getElementById("scanner-modal").style.display = "none"; }
  }
</script>
</body>
</html>
