<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MEC ‚Äì Reemplazos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --azul-empresa: #003a70; /* Azul Carrefour */
    --azul-accion: #007bff;
    --gris-fondo: #f0f2f5;
    --verde-exito: #28a745;
    --rojo-error: #dc3545;
  }

  body { 
    font-family: 'Roboto', sans-serif; 
    margin: 0; 
    padding: 0; 
    background-color: var(--gris-fondo); 
    color: #333;
  }

  header { 
    background: var(--azul-empresa); 
    color: white; 
    padding: 15px; 
    display: flex; 
    justify-content: center; /* Centra el t√≠tulo */
    align-items: center; 
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  header span { font-weight: 700; font-size: 1.1rem; letter-spacing: 1px; }

  /* CORRECCI√ìN MEN√ö: Posici√≥n absoluta a la derecha */
  #menu-btn { 
    background: none; 
    border: none; 
    font-size: 28px; 
    color: white; 
    cursor: pointer; 
    position: absolute; 
    right: 15px; 
    top: 50%;
    transform: translateY(-50%);
    padding: 5px;
  }

  #menu-content { 
    display: none; 
    position: absolute; 
    right: 15px; 
    top: 60px; 
    background: white; 
    border-radius: 12px; 
    padding: 20px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
    z-index: 1500; 
    width: 250px; 
  }

  main { padding: 15px; max-width: 550px; margin: auto; }

  /* ESTILO TARJETAS */
  .card {
    background: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  h3 { margin-top: 0; color: var(--azul-empresa); font-size: 0.9rem; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

  label { font-weight: 500; display: block; margin-top: 12px; font-size: 14px; color: #666; }

  input, select { 
    width: 100%; 
    padding: 14px; 
    font-size: 16px; 
    margin-top: 5px; 
    box-sizing: border-box; 
    border: 1.5px solid #ddd; 
    border-radius: 10px;
    background-color: #fafafa;
    transition: border-color 0.3s;
  }

  input:focus { border-color: var(--azul-accion); outline: none; background-color: white; }

  /* BOTONES P√çLDORA */
  button { 
    width: 100%; 
    padding: 15px; 
    font-size: 16px; 
    margin-top: 10px; 
    box-sizing: border-box; 
    border: none; 
    border-radius: 50px; /* Estilo P√≠ldora */
    font-weight: 700; 
    cursor: pointer; 
    transition: transform 0.1s, opacity 0.3s;
  }

  button:active { transform: scale(0.98); }

  .btn-scan { background-color: #e9ecef; color: var(--azul-empresa); border: 1.5px solid var(--azul-empresa); margin-top: 8px; }
  
  #btnEnviar { background-color: var(--azul-empresa); color: white; margin-top: 30px; font-size: 18px; box-shadow: 0 4px 12px rgba(0,58,112,0.3); }

  .detalle-container { display: none; background: #fdfdfd; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px dashed var(--azul-accion); }

  /* MODALES Y AVISOS */
  #scanner-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; }
  #reader { width: 90%; max-width: 400px; background: white; border-radius: 15px; overflow: hidden; }
  
  .modal-alerta { 
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    background: white; 
    padding: 30px; 
    border-radius: 20px; 
    z-index: 3000; 
    width: 85%; 
    text-align: center; 
    box-shadow: 0 15px 50px rgba(0,0,0,0.3); 
  }

  #mensaje { text-align: center; margin-top: 20px; font-weight: 700; font-size: 1.1rem; }
</style>
</head>
<body>

<header>
  <span>MEC REEMPLAZOS</span>
  <button id="menu-btn" onclick="toggleMenu()">‚ò∞</button>
  <div id="menu-content">
    <h4 style="margin:0 0 10px 0">Modo Correcci√≥n</h4>
    <label>Fila en Planilla:</label>
    <input type="number" id="input_fila" inputmode="numeric" placeholder="Nro de fila">
    <button onclick="cargarFila()" style="background:var(--azul-empresa); color:white; margin-top:10px">Cargar Datos</button>
  </div>
</header>

<div id="aviso-error" class="modal-alerta">
  <div style="font-size: 50px; margin-bottom: 10px;">‚ö†Ô∏è</div>
  <p style="color: var(--rojo-error); font-weight: bold; font-size: 1.2rem;">EAN IGUALES</p>
  <p>El c√≥digo de origen y reemplazo no pueden ser el mismo.</p>
  <button onclick="cerrarAviso('aviso-error')" style="background-color: #666;">ENTENDIDO</button>
</div>

<div id="aviso-duplicado" class="modal-alerta">
  <div style="font-size: 50px; margin-bottom: 10px;">üö´</div>
  <p id="msg-duplicado" style="color: var(--rojo-error); font-weight: bold; font-size: 1.1rem;"></p>
  <button onclick="cerrarAviso('aviso-duplicado')" style="background-color: #666;">CERRAR</button>
</div>

<main>
  <h2 id="titulo-modo" style="text-align: center; font-size: 1.3rem; margin-bottom: 20px;">Nueva Carga</h2>
  
  <div class="card">
    <h3>Datos de Control</h3>
    <label>Pickeador</label>
    <select id="pickeador">
      <option value="">Seleccionar...</option>
      <option>Juan</option>
      <option>Ana</option>
      <option>Carlos</option>
    </select>
    
    <label>N√∫mero de Pedido</label>
    <input type="text" id="nro_pedido" inputmode="numeric" placeholder="Escanear o escribir">
    <button type="button" class="btn-scan" onclick="iniciarEscaneo('nro_pedido')">üì∑ ESCANEAR PEDIDO</button>
    
    <label>Fecha de Operaci√≥n</label>
    <input type="date" id="fecha">
  </div>

  <div class="card">
    <h3>Producto Original (MEC)</h3>
    <label>EAN Origen</label>
    <input type="text" id="ean_origen" inputmode="numeric" oninput="checkEAN(this, 'cont_origen')" placeholder="EAN fuera de stock">
    
    <div id="cont_origen" class="detalle-container">
      <label>Detalle (Art. Pesable):</label>
      <input type="text" id="det_origen" placeholder="Ej: Manzana Roja">
    </div>

    <label>Cantidad/Peso Original</label>
    <input type="text" id="uni_origen" inputmode="decimal" value="1">
  </div>

  <div class="card">
    <h3>Producto Reemplazo</h3>
    <label>EAN Reemplazo</label>
    <input type="text" id="ean_reemplazo" inputmode="numeric" oninput="checkEAN(this, 'cont_reemplazo')" placeholder="EAN entregado">
    <button type="button" class="btn-scan" onclick="iniciarEscaneo('ean_reemplazo')">üì∑ ESCANEAR REEMPLAZO</button>

    <div id="cont_reemplazo" class="detalle-container">
      <label>Detalle (Art. Pesable):</label>
      <input type="text" id="det_reemplazo" placeholder="Ej: Manzana Gala">
    </div>

    <label>Cantidad/Peso Reemplazo</label>
    <input type="text" id="uni_reemplazo" inputmode="decimal" value="1">
  </div>
  
  <button id="btnEnviar" onclick="validar()">‚úÖ GUARDAR DATOS</button>
  <button id="btnCancelar" onclick="cancelarEdicion()" style="display:none; background:var(--rojo-error); margin-top:15px">‚ùå CANCELAR EDICI√ìN</button>
  
  <p id="mensaje"></p>
</main>

<div id="scanner-modal">
    <div id="reader"></div>
    <button onclick="detenerEscaneo()" style="width: 80px; height: 80px; border-radius: 50%; background: white; color: red; margin-top: 30px; font-size: 24px;">X</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  // --- LA L√ìGICA NO SE TOCA ---
  const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbxymyQAzHrmo5axoTOJCBQU-B7BNfQf0HaS4mebm8gJLI6M4nna9hEUaEBPL8x-ogoeUg/exec"; 
  let html5QrCode, campoDestino, modoEdicion = false, filaEdicion = null;
  document.getElementById("fecha").valueAsDate = new Date();

  function vibrar() { if (navigator.vibrate) navigator.vibrate(200); }

  function checkEAN(input, containerId) {
    const val = input.value.trim();
    const prefijos = ["23", "25", "26", "29"];
    const container = document.getElementById(containerId);
    container.style.display = prefijos.some(p => val.startsWith(p)) ? "block" : "none";
  }

  function formatearUnidad(valor) {
    let s = valor.toString().replace(',', '.').trim();
    if (!s) return "0";
    if (s.startsWith('.') || s.startsWith(',')) s = "0." + s.substring(1);
    return s.includes('.') ? parseFloat(s) + " kg" : s;
  }

  function toggleMenu() {
    const m = document.getElementById("menu-content");
    m.style.display = m.style.display === "block" ? "none" : "block";
  }

  async function cargarFila() {
    const nro = document.getElementById("input_fila").value;
    if(!nro) return;
    mostrar("Buscando... ‚è≥", var(--azul-empresa)); toggleMenu();
    try {
      const resp = await fetch(URL_APPS_SCRIPT + "?nro_fila=" + nro);
      const d = await resp.json();
      if(d.status === "error") { mostrar("No encontrada", "red"); return; }
      
      document.getElementById("pickeador").value = d.pickeador;
      document.getElementById("nro_pedido").value = d.nro_pedido;
      document.getElementById("fecha").value = d.fecha;
      document.getElementById("ean_origen").value = d.ean_origen;
      document.getElementById("uni_origen").value = d.uni_origen.toString().replace(" kg","");
      document.getElementById("ean_reemplazo").value = d.ean_reemplazo;
      document.getElementById("uni_reemplazo").value = d.uni_reemplazo.toString().replace(" kg","");
      document.getElementById("det_origen").value = d.det_origen || "";
      document.getElementById("det_reemplazo").value = d.det_reemplazo || "";
      
      checkEAN(document.getElementById("ean_origen"), 'cont_origen');
      checkEAN(document.getElementById("ean_reemplazo"), 'cont_reemplazo');
      
      modoEdicion = true; filaEdicion = nro;
      document.getElementById("titulo-modo").innerText = "MODO CORRECCI√ìN - FILA " + nro;
      document.getElementById("btnEnviar").innerText = "üîÑ ACTUALIZAR FILA";
      document.getElementById("btnEnviar").style.background = "#fd7e14";
      document.getElementById("btnCancelar").style.display = "block";
      mostrar("Fila cargada ‚úÖ", "var(--azul-accion)");
    } catch (e) { mostrar("Error lectura ‚ùå", "red"); }
  }

  function iniciarEscaneo(id) {
    campoDestino = id; document.getElementById("scanner-modal").style.display = "flex";
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } },
      (text) => { 
        vibrar();
        document.getElementById(campoDestino).value = text.trim(); 
        if (campoDestino === 'ean_reemplazo') checkEAN(document.getElementById(campoDestino), 'cont_reemplazo');
        detenerEscaneo(); 
      }, () => {}
    ).catch(() => { alert("Error c√°mara"); detenerEscaneo(); });
  }

  function detenerEscaneo() {
    if (html5QrCode && html5QrCode.isScanning) {
      html5QrCode.stop().then(() => { document.getElementById("scanner-modal").style.display = "none"; });
    } else { document.getElementById("scanner-modal").style.display = "none"; }
  }

  async function validar() {
    const btn = document.getElementById("btnEnviar");
    const datos = {
      accion: modoEdicion ? "actualizar" : "insertar",
      nro_fila: filaEdicion,
      pickeador: document.getElementById("pickeador").value,
      nro_pedido: document.getElementById("nro_pedido").value.trim(),
      fecha: document.getElementById("fecha").value,
      ean_origen: document.getElementById("ean_origen").value.trim(),
      uni_origen: formatearUnidad(document.getElementById("uni_origen").value),
      ean_reemplazo: document.getElementById("ean_reemplazo").value.trim(),
      uni_reemplazo: formatearUnidad(document.getElementById("uni_reemplazo").value),
      det_origen: document.getElementById("det_origen").value.trim(),
      det_reemplazo: document.getElementById("det_reemplazo").value.trim()
    };

    if (!datos.pickeador || !datos.nro_pedido || !datos.ean_origen || !datos.ean_reemplazo) {
      mostrar("FALTAN DATOS ‚ùå", "red"); return;
    }
    if (datos.ean_origen === datos.ean_reemplazo) {
      document.getElementById("aviso-error").style.display = "block"; return;
    }

    btn.disabled = true; mostrar("ENVIANDO... ‚è≥", "orange");
    try {
      const resp = await fetch(URL_APPS_SCRIPT, { method: "POST", body: JSON.stringify(datos) });
      const resJson = await resp.json();
      
      if (resJson.status === "duplicado") {
        document.getElementById("msg-duplicado").innerText = resJson.mensaje;
        document.getElementById("aviso-duplicado").style.display = "block";
        mostrar("ERROR: DUPLICADO ‚ùå", "red");
      } else {
        mostrar("GUARDADO CON √âXITO ‚úÖ", "green");
        if (modoEdicion) cancelarEdicion();
        else { 
          document.getElementById("ean_origen").value = ""; document.getElementById("ean_reemplazo").value = "";
          document.getElementById("uni_origen").value = "1"; document.getElementById("uni_reemplazo").value = "1";
          document.querySelectorAll('.detalle-container').forEach(c => c.style.display = "none");
        }
      }
    } catch (err) { mostrar("ERROR DE RED ‚ùå", "red"); }
    finally { btn.disabled = false; }
  }

  function cancelarEdicion() {
    modoEdicion = false; filaEdicion = null;
    document.getElementById("titulo-modo").innerText = "Nueva Carga";
    document.getElementById("btnEnviar").innerText = "‚úÖ GUARDAR DATOS";
    document.getElementById("btnEnviar").style.background = "var(--azul-empresa)";
    document.getElementById("btnCancelar").style.display = "none";
    mostrar("Edici√≥n cancelada", "#333");
  }

  function cerrarAviso(id) { document.getElementById(id).style.display = "none"; }
  function mostrar(t, c) { const m = document.getElementById("mensaje"); m.innerText = t; m.style.color = c; }
</script>
</body>
</html>
